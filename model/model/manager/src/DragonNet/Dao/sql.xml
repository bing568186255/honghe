<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap        
    PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN"        
    "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap>
	<sql id="lyxm">
		(SELECT
		A .*, D ."JSJD" AS "JSZT"
		FROM
		"HHLY_LYXM" A
		LEFT JOIN (
		SELECT
		*
		FROM
		(
		SELECT
		b.*, ROW_NUMBER () OVER (
		PARTITION BY b."XMID"
		ORDER BY
		b."RQ" DESC
		) AS rk
		FROM
		HHLY_XMKFQKTB b
		) c
		WHERE
		c.rk = 1
		) D ON A ."ID" = D ."XMID")
	</sql>

	<select id="getXMSTJ" parameterClass="java.util.HashMap"
		resultClass="java.util.HashMap">
		select b."BM" as "bm" ,b."MC" as "qxmc" ,nvl(a."xms",0) as
		"xms"
		from
		"HHLY_QXDY" b
		left join
		(select "QXBM" , count("ID") as "xms"
		FROM "HHLY_LYXM" GROUP BY "QXBM") a
		on a."QXBM" = b."BM"
	</select>

	<select id="getXMMJTJ" parameterClass="java.util.HashMap"
		resultClass="java.util.HashMap">
		select b."BM" as "bm", b."MC" as "qxmc",nvl(a."xmmj",0) as
		"xmmj"
		from
		"HHLY_QXDY" b
		left join
		(select "QXBM" AS "qxbm" ,
		sum("GHYD")as "xmmj" FROM "HHLY_LYXM" group by "QXBM")
		a
		on a."qxbm" =
		b."BM"
	</select>

	<select id="getJSZTTJ" parameterClass="java.util.HashMap"
		resultClass="java.util.HashMap">
		select
		"JSZT" AS "jszt"
		, count("ID")as "xms"
		FROM
		<include refid="lyxm" />
		group by "JSZT"
	</select>

	<select id="getXMSXTJ" parameterClass="java.util.HashMap"
		resultClass="java.util.HashMap">
		select
		"XMSX" AS "xmsx"
		, count("ID")as "xms"
		FROM
		"HHLY_LYXM"
		group by "XMSX"
	</select>

	<!-- <select id="getLYXM" parameterClass="java.util.HashMap" resultClass="java.util.HashMap"> 
		select * FROM "LYXM" <dynamic prepend="where"> <isPropertyAvailable prepend="and" 
		property="type"> "xmdz"=#type# </isPropertyAvailable> <isPropertyAvailable 
		prepend="and" property="id"> "qxbm"=#id# </isPropertyAvailable> </dynamic> 
		</select> -->



	<select id="getLYXMGL" parameterClass="java.util.HashMap"
		resultClass="java.util.HashMap">
		select *
		FROM
		<include refid="lyxm" />
		<dynamic prepend="where">
			<isPropertyAvailable prepend="and" property="qxbm">
				"QXBM"=#qxbm#
			</isPropertyAvailable>
			<isPropertyAvailable prepend="and" property="jszt">
				"JSZT" in
				<iterate open=" (" close=")" conjunction="," property="jszt">
					#jszt[]#
				</iterate>
			</isPropertyAvailable>
			<isPropertyAvailable prepend="and" property="xmsx">
				"XMSX" in
				<iterate open=" (" close=")" conjunction="," property="xmsx">
					#xmsx[]#
				</iterate>
			</isPropertyAvailable>
			<isPropertyAvailable prepend="and" property="xmyt">
				"XMYT" in
				<iterate open=" (" close=")" conjunction="," property="xmyt">
					#xmyt[]#
				</iterate>
			</isPropertyAvailable>
			<isPropertyAvailable prepend="and" property="xmxz">
				"XMXZ" in
				<iterate open=" (" close=")" conjunction="," property="xmxz">
					#xmxz[]#
				</iterate>
			</isPropertyAvailable>
		</dynamic>
		<!-- <dynamic prepend="where"> <isPropertyAvailable prepend="and" property="qxbm"> 
			"qxbm"=#qxbm# </isPropertyAvailable> <isPropertyAvailable prepend="and" property="jszt"> 
			"jszt"=#jszt# </isPropertyAvailable> <isPropertyAvailable prepend="and" property="xmsx"> 
			"xmsx"=#xmsx# </isPropertyAvailable> <isPropertyAvailable prepend="and" property="xmyt"> 
			"xmyt"=#xmyt# </isPropertyAvailable> <isPropertyAvailable prepend="and" property="xmxz"> 
			"xmxz"=#xmxz# </isPropertyAvailable> </dynamic> -->
	</select>

	<select id="getLYXMTotal" parameterClass="java.util.HashMap"
		resultClass="java.util.HashMap">
		SELECT
		"QXBM" AS "qxbm",
		COUNT (*) AS "xmzs",
		SUM ("ZTZ") AS "xmztz",
		SUM
		("SJLJTZ") AS "sjljtz",
		SUM ("JSYD") AS "jssl",
		SUM ("GHYD") AS "ghsl"
		FROM
		<include refid="lyxm" />
		<dynamic prepend="where">
			<isPropertyAvailable prepend="and" property="qxbm">
				"QXBM" = #qxbm#
				<!-- "qxbm" in <iterate open=" (" close=")" conjunction="," property="qxbm"> 
					#qxbm[]# </iterate> -->
			</isPropertyAvailable>
			<isPropertyAvailable prepend="and" property="jszt">
				"JSZT" in
				<iterate open=" (" close=")" conjunction="," property="jszt">
					#jszt[]#
				</iterate>
			</isPropertyAvailable>
			<isPropertyAvailable prepend="and" property="xmsx">
				"XMSX" in
				<iterate open=" (" close=")" conjunction="," property="xmsx">
					#xmsx[]#
				</iterate>
			</isPropertyAvailable>
			<isPropertyAvailable prepend="and" property="xmyt">
				"XMYT" in
				<iterate open=" (" close=")" conjunction="," property="xmyt">
					#xmyt[]#
				</iterate>
			</isPropertyAvailable>
			<isPropertyAvailable prepend="and" property="xmxz">
				"XMXZ" in
				<iterate open=" (" close=")" conjunction="," property="xmxz">
					#xmxz[]#
				</iterate>
			</isPropertyAvailable>
		</dynamic>
		group by "QXBM"
	</select>

	<select id="getLYXMWGS" parameterClass="java.util.HashMap"
		resultClass="java.util.HashMap">
		SELECT
		COUNT (*) AS "xmzs",
		SUM ("ZTZ") AS "xmztz",
		SUM ("SJLJTZ") AS
		"sjljtz"
		FROM
		<include refid="lyxm" />
		<dynamic prepend="where">
			<isPropertyAvailable prepend="and" property="qxbm">
				"QXBM"=#qxbm#
			</isPropertyAvailable>
			<isPropertyAvailable prepend="and" property="jszt">
				"JSZT"=#jszt#
			</isPropertyAvailable>
		</dynamic>
		group by "QXBM"
	</select>

	<select id="getQXinfo" parameterClass="java.util.HashMap"
		resultClass="java.util.HashMap">
		SELECT
		*
		FROM
		"HHLY_QXDY"
		<dynamic prepend="where">
			<isPropertyAvailable prepend="and" property="qxbm">
				"BM"=#qxbm#
			</isPropertyAvailable>
		</dynamic>
	</select>

	<select id="getXMKFQK" parameterClass="java.util.HashMap"
		resultClass="java.util.HashMap">
		select
		a."ID"
		,a."XMID"
		,to_char(a."RQ",'yyyy-MM-dd') RQ
		,D.XMM XMMC
		,d."XMJD" JSJD
		, a."SM"
		,d."SJTBY" as sjtby
		,b."TPLJ"
		,a."TPSL" as tpsl
		,c."TPLJ" AS DW
		from
		"HHLY_XMKFQKTB" a

		LEFT JOIN "HHLY_SCTP" b

		on a."ID" = b."XMKFQKID"

		LEFT JOIN "HHLY_XMTPLX" c

		ON b."TPLX" = c."ID"

		LEFT JOIN "HHLY_LYXM" d
		ON A."XMID" = d."CODE"
		<dynamic prepend="where">
			<isPropertyAvailable prepend="and" property="id">
				a."XMID"=#id#
			</isPropertyAvailable>
			<isPropertyAvailable prepend="and" property="xmrq">
				to_char(a."RQ",'yyyy-MM-dd')=#xmrq#
			</isPropertyAvailable>
		</dynamic>
		order by rq desc

	</select>
	<select id="getXCTBYDW" parameterClass="java.util.HashMap"
		resultClass="java.util.HashMap">
		SELECT a."dw"
		,b."url" ,b."xmid"

		from

		HHLY_DW a

		LEFT JOIN HHLY_XCT b

		ON a."id" = b."dwid"
		where
		b."xmid"=#xmid#
		and a."id"=#dw#



	</select>




	<select id="xmDetail" parameterClass="java.util.HashMap"
		resultClass="java.util.HashMap">
		select
		a."XMM" as "xmm",
		a."XMDZ" as "xmdz",
		a."XMGK" as "xmgk",
		a."SZFW"
		as "szfw",
		a."XMSX" as "xmsx",
		a."XMLX" as "xmlx",
		a."XMXZ" as "xmxz",
		a."ZTZ" as "ztz",
		a."XMYT" as "xmyt",
		a."GHYD" as "ghyd",
		a."ZDXMXZJWH"
		as "zdxmxzjwh",
		to_char(a."KGSJ",'YYYY-MM-DD') as "kgsj",
		to_char(a."JSZQ",'YYYY-MM-DD') as "jszq",
		a."SJLJTZ" as "sjljtz",
		a."XMZGDW" as "xmzgdw",
		a."XMFZRDH" as "xmfzrdh",
		a."XMFZR" as "xmfzr",
		b."TZDWMC" as "tzdwmc",
		b."TZXZ" as "tzxz",
		b."TZBL" as "tzbl",
		b."BZ" as
		"bz",
		b."TZDWQK" as "tzdwqk"
		from
		<include refid="lyxm" />
		a
		left join
		"HHLY_XMTZQKTB" b on a."XMM" = b."XMMC"
		<isPropertyAvailable prepend="and" property="xmmc">
			a."XMM"=#xmmc#
		</isPropertyAvailable>
	</select>


	<select id="getLocation" parameterClass="java.util.HashMap"
		resultClass="java.lang.String">
		select $field$ as ZB
		FROM $table$
		where id=#id#
	</select>
	<update id="updateLocation" parameterClass="java.util.HashMap">
		update $table$
		set $field$ = #zb#
		where id=#id#
	</update>

	<select id="getLyxmGPS" parameterClass="java.lang.String"
		resultClass="java.util.HashMap">
		select XMZB as ZB,XMFW as FW
		from HHLY_LYXM
		where id=#value#
	</select>
	<update id="updateLyxmGPS" parameterClass="java.util.HashMap">
		update HHLY_LYXM
		<dynamic prepend="set">
			<isPropertyAvailable prepend="," property="xmzb">
				XMZB = #xmzb#
			</isPropertyAvailable>
			<isPropertyAvailable prepend="," property="xmfw">
				XMFW = #xmfw#
			</isPropertyAvailable>
		</dynamic>
		where id=#id#
	</update>
</sqlMap>  
